
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Flag Quest Kids ‚Äî Single File (v5)</title>
  <meta name="description" content="Guess the Flag ‚Äî kids-friendly, multilingual, single-file (HTML+JS)">
  <style>
  :root{
    --bg:#0b1220; --card:#0f172a; --text:#f3f4f6; --muted:#cbd5e1; --accent:#0ea5e9;
    --good:#16a34a; --bad:#ef4444; --warning:#f59e0b; --shadow:0 10px 30px rgba(0,0,0,.3);
    --option:#182237; --option-border:#2b3a59; --option-hover:#223157;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
       background:radial-gradient(1000px 600px at 20% -10%, #23325a, #0b1220); color:var(--text);
       display:flex; flex-direction:column}
  header, footer{display:flex;align-items:center;justify-content:space-between;gap:12px;
       padding:12px 16px;background:rgba(15,23,42,.75);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.08)}
  footer{border-top:1px solid rgba(255,255,255,.08);margin-top:auto}
  .brand{display:flex;align-items:center;gap:10px}
  .tag{font-size:.7em;padding:2px 8px;background:var(--accent);color:black;border-radius:999px;margin-left:6px}
  main{max-width:980px;width:100%;margin:0 auto;padding:12px}
  .screen{display:none} .screen.active{display:block}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}
  .row{display:flex;gap:12px;align-items:center} .wrap{flex-wrap:wrap} .space{justify-content:space-between} .right{justify-content:flex-end}
  .muted{color:var(--muted)}
  .btn{border:none;background:var(--accent);color:black;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
  .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.3)}
  .btn.danger{background:var(--bad);color:white} .btn:disabled{opacity:.6;cursor:not-allowed}
  .mode-card{flex:1;min-width:260px;padding:12px;border:1px dashed rgba(255,255,255,.18);border-radius:12px}
  .chip{display:inline-flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;cursor:pointer}
  .chip input{transform:scale(1.2)}
  .flag-wrap{display:flex;justify-content:center;margin:16px 0}
  .flag{max-width:min(80vw,520px);width:100%;height:auto;border-radius:14px;border:1px solid rgba(255,255,255,.18);box-shadow:var(--shadow);background:#0a0f1d}
  .hud{display:flex;gap:12px;align-items:center;font-weight:700} #hudTimer{color:var(--warning)} #hudScore{color:#34d399} #hudStreak{color:#93c5fd}
  #questionArea{display:flex;flex-direction:column;gap:12px;align-items:center}
  .options{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:12px;width:100%;max-width:640px}
  .option{background:var(--option);border:2px solid var(--option-border);padding:12px;border-radius:12px;cursor:pointer;text-align:center;color:var(--text);font-weight:700}
  .option:hover{outline:0; background:var(--option-hover)}
  .option.correct{background:rgba(34,197,94,.25);border-color:rgba(34,197,94,.6);color:#ecfdf5}
  .option.wrong{background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.6);color:#fee2e2}
  .input-wrap{display:flex;gap:8px;width:100%;max-width:640px}
  .input-wrap input{flex:1;padding:12px;border-radius:12px;border:2px solid var(--option-border);background:var(--option);color:var(--text)}
  .autocomplete{display:grid;gap:6px;width:100%;max-width:640px}
  .suggestion{padding:8px;background:var(--option);border:2px solid var(--option-border);border-radius:10px;cursor:pointer}
  .hint{color:var(--muted); min-height:1.6em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .hidden{display:none !important}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.15);text-align:left}
  th{color:#c7d2fe;font-weight:800}
  /* Language dropdown */
  .lang-btn{min-width:86px; display:flex; align-items:center; gap:6px; justify-content:center}
  .lang-flag{font-size:1.1em}
  .lang-code{font-weight:800}
  .lang-menu{position:absolute; margin-top:6px; right:62px; background:var(--card); border:1px solid rgba(255,255,255,.2); border-radius:12px; box-shadow:var(--shadow); padding:6px; display:none; z-index:1000; width:240px; max-height:60vh; overflow:auto}
  .lang-menu.open{display:block}
  .lang-item{padding:8px 12px; cursor:pointer; border-radius:8px; display:flex; align-items:center; gap:8px}
  .lang-item:hover{background:rgba(255,255,255,.08)}
  /* Stable footer row */
  .game-footer{display:flex; align-items:center; gap:12px}
  .game-footer .spacer{flex:1}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div style="width:36px;height:36px;border-radius:8px;background:#0ea5e9;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)">üè≥Ô∏è</div>
      <h1>Flag Quest <span class="tag">Kids</span></h1>
    </div>
    <div class="row" style="position:relative">
      <button id="btnLanguage" class="btn secondary lang-btn"><span class="lang-flag">üá¨üáß</span><span class="lang-code">EN</span></button>
      <div id="langMenu" class="lang-menu" role="menu" aria-label="Language menu">
        <div class="lang-item" data-lang="en"><span class="lang-flag">üá¨üáß</span><span>EN ‚Äî English</span></div>
        <div class="lang-item" data-lang="pl"><span class="lang-flag">üáµüá±</span><span>PL ‚Äî Polski</span></div>
        <div class="lang-item" data-lang="es"><span class="lang-flag">üá™üá∏</span><span>ES ‚Äî Espa√±ol</span></div>
        <div class="lang-item" data-lang="de"><span class="lang-flag">üá©üá™</span><span>DE ‚Äî Deutsch</span></div>
        <div class="lang-item" data-lang="it"><span class="lang-flag">üáÆüáπ</span><span>IT ‚Äî Italiano</span></div>
        <div class="lang-item" data-lang="ru"><span class="lang-flag">üá∑üá∫</span><span>RU ‚Äî –†—É—Å—Å–∫–∏–π</span></div>
        <div class="lang-item" data-lang="pt"><span class="lang-flag">üáµüáπ</span><span>PT ‚Äî Portugu√™s</span></div>
      </div>
      <button id="btnSettings" class="btn secondary">‚öôÔ∏è</button>
    </div>
  </header>

  <main>
    <section id="screenStart" class="screen active">
      <div class="card">
        <h2 data-i18n="title_play">Play</h2>
        <div class="row wrap">
          <div class="mode-card">
            <h3 data-i18n="learning">Learning</h3>
            <p class="muted" data-i18n="desc_learning">Relaxed mode with hints.</p>
            <div class="row" style="gap:8px">
              <button class="btn" data-mode="learning" data-variant="mcq" data-i18n="btn_mcq">Multiple Choice</button>
              <button class="btn" data-mode="learning" data-variant="typing" data-i18n="btn_typing">Typing</button>
            </div>
          </div>
          <div class="mode-card">
            <h3 data-i18n="competitive">Competitive</h3>
            <p class="muted" data-i18n="desc_competitive">60s sprint with streaks.</p>
            <div class="row" style="gap:8px">
              <button class="btn" data-mode="competitive" data-variant="mcq" data-i18n="btn_mcq">Multiple Choice</button>
              <button class="btn" data-mode="competitive" data-variant="typing" data-i18n="btn_typing">Typing</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 data-i18n="title_filters">Filters</h2>
        <div class="row wrap" style="gap:10px">
          <label class="chip"><input type="checkbox" class="continent" value="Africa" checked> <span data-i18n="africa">Africa</span></label>
          <label class="chip"><input type="checkbox" class="continent" value="Asia" checked> <span data-i18n="asia">Asia</span></label>
          <label class="chip"><input type="checkbox" class="continent" value="Europe" checked> <span data-i18n="europe">Europe</span></label>
          <label class="chip"><input type="checkbox" class="continent" value="North America" checked> <span data-i18n="north_america">North America</span></label>
          <label class="chip"><input type="checkbox" class="continent" value="South America" checked> <span data-i18n="south_america">South America</span></label>
          <label class="chip"><input type="checkbox" class="continent" value="Oceania" checked> <span data-i18n="oceania">Oceania</span></label>
        </div>
      </div>

      <div class="card">
        <h2 data-i18n="title_leaderboard">Local High Scores</h2>
        <div id="leaderboard"></div>
      </div>
    </section>

    <section id="screenGame" class="screen">
      <div class="row space">
        <button id="btnBack" class="btn secondary" data-i18n="btn_back">Back</button>
        <div class="hud">
          <span id="hudMode"></span>
          <span id="hudTimer"></span>
          <span id="hudScore"></span>
          <span id="hudStreak"></span>
        </div>
      </div>
      <div class="flag-wrap">
        <img id="flagImg" alt="flag" class="flag">
      </div>
      <div id="questionArea"></div>

      <div class="game-footer">
        <div class="hint" id="hintBox"></div>
        <div class="spacer"></div>
        <button id="btnToggleHint" class="btn secondary hidden" data-i18n="btn_show_hint">Show hint</button>
        <button id="btnSkip" class="btn secondary" data-i18n="btn_skip">Skip</button>
      </div>
    </section>

    <dialog id="dlgSettings">
      <form method="dialog">
        <h3 data-i18n="title_settings">Settings</h3>
        <label class="row space">
          <span data-i18n="label_language">Language</span>
          <select id="selLang">
            <option value="en">English</option>
            <option value="pl">Polski</option>
            <option value="es">Espa√±ol</option>
            <option value="de">Deutsch</option>
            <option value="it">Italiano</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="pt">Portugu√™s</option>
          </select>
        </label>
        <label class="row space">
          <span data-i18n="label_donate">Show donate link</span>
          <input type="checkbox" id="chkDonate">
        </label>
        <details>
          <summary data-i18n="title_parental">Parental / Teacher</summary>
          <label class="row space">
            <span data-i18n="label_pin">Enter PIN to reset (default 1234)</span>
            <input type="password" id="pinInput" placeholder="1234">
            <button id="btnResetProgress" class="btn danger" type="button" data-i18n="btn_reset">Reset Progress</button>
          </label>
        </details>
        <div class="row right">
          <button class="btn" value="ok" data-i18n="btn_close">Close</button>
        </div>
      </form>
    </dialog>
  </main>

  <footer>
    <span>&copy; <span id="year"></span> Flag Quest</span>
    <a id="donateLink" href="#" class="hidden" rel="noopener" target="_blank">Donate</a>
    <span class="muted">Single-file HTML ‚Ä¢ Online needed on first load for full dataset/flags</span>
  </footer>

  <script>
  // --- i18n ---
  const I18N = {
    en:{title_play:"Play",desc_learning:"Relaxed mode with hints.",desc_competitive:"60s sprint with streaks.",btn_mcq:"Multiple Choice",btn_typing:"Typing",
        title_filters:"Filters",title_leaderboard:"Local High Scores",btn_back:"Back",btn_skip:"Skip",title_settings:"Settings",label_language:"Language",
        title_parental:"Parental / Teacher",label_pin:"Enter PIN to reset (default 1234)",btn_reset:"Reset Progress",btn_close:"Close",label_donate:"Show donate link",
        learning:"Learning",competitive:"Competitive",streak:"Streak",score:"Score",time:"Time",hint_continent:"Continent:",hint_first:"First letter:",
        btn_show_hint:"Show hint üí°",btn_hide_hint:"Hide hint üí°",
        correct:"Correct!",wrong:"Try again!",over:"Time's up!",donate_text:"Donate",
        africa:"Africa",asia:"Asia",europe:"Europe",north_america:"North America",south_america:"South America",oceania:"Oceania",
        th_date:"Date",th_mode:"Mode",th_variant:"Variant",th_continents:"Continents",th_score:"Score",th_beststreak:"Best Streak",
        ph_typing:"Type country name‚Ä¶",btn_ok:"OK"},
    pl:{title_play:"Graj",desc_learning:"Spokojny tryb z podpowiedziami.",desc_competitive:"Sprint 60 s z seriami.",btn_mcq:"ABCD",btn_typing:"Pisanie ‚å®Ô∏è",
        title_filters:"Filtry",title_leaderboard:"Lokalne wyniki",btn_back:"Wr√≥ƒá",btn_skip:"Pomi≈Ñ",title_settings:"Ustawienia",label_language:"Jƒôzyk",
        title_parental:"Rodzic / Nauczyciel",label_pin:"PIN do resetu (domy≈õlnie 1234)",btn_reset:"Wyzeruj postƒôp",btn_close:"Zamknij",label_donate:"Poka≈º link wsparcia",
        learning:"Nauka",competitive:"Stoper ‚è±Ô∏è",streak:"Seria",score:"Wynik",time:"Czas",hint_continent:"Kontynent:",hint_first:"Pierwsza litera:",
        btn_show_hint:"Poka≈º podpowied≈∫ üí°", btn_hide_hint:"Ukryj podpowied≈∫ üí°",
        correct:"Dobrze!",wrong:"Spr√≥buj ponownie!",over:"Koniec czasu!",donate_text:"Wesprzyj",
        africa:"Afryka",asia:"Azja",europe:"Europa",north_america:"Ameryka P√≥≈Çnocna",south_america:"Ameryka Po≈Çudniowa",oceania:"Australia i Oceania",
        th_date:"Data",th_mode:"Tryb",th_variant:"Wariant",th_continents:"Kontynenty",th_score:"Wynik",th_beststreak:"Najlepsza seria",
        ph_typing:"Wpisz nazwƒô kraju‚Ä¶",btn_ok:"OK"},
    es:{title_play:"Jugar",desc_learning:"Modo relajado con pistas.",desc_competitive:"Carrera de 60 s con rachas.",btn_mcq:"Opci√≥n m√∫ltiple",btn_typing:"Escribir nombre ‚å®Ô∏è",
        title_filters:"Filtros",title_leaderboard:"Puntuaciones locales",btn_back:"Atr√°s",btn_skip:"Saltar",title_settings:"Ajustes",label_language:"Idioma",
        title_parental:"Padres / Profesor",label_pin:"PIN para restablecer (por defecto 1234)",btn_reset:"Restablecer",btn_close:"Cerrar",label_donate:"Mostrar enlace de donaci√≥n",
        learning:"Aprender",competitive:"Competitivo ‚è±Ô∏è",streak:"Racha",score:"Puntuaci√≥n",time:"Tiempo",hint_continent:"Continente:",hint_first:"Primera letra:",
        btn_show_hint:"Mostrar pista üí°", btn_hide_hint:"Ocultar pista üí°",
        correct:"¬°Correcto!",wrong:"¬°Int√©ntalo de nuevo!",over:"¬°Se acab√≥ el tiempo!",donate_text:"Donar",
        africa:"√Åfrica",asia:"Asia",europe:"Europa",north_america:"Am√©rica del Norte",south_america:"Am√©rica del Sur",oceania:"Ocean√≠a",
        th_date:"Fecha",th_mode:"Modo",th_variant:"Variante",th_continents:"Continentes",th_score:"Puntuaci√≥n",th_beststreak:"Mejor racha",
        ph_typing:"Escribe el pa√≠s‚Ä¶",btn_ok:"OK"},
    de:{title_play:"Spielen",desc_learning:"Entspannter Modus mit Hinweisen.",desc_competitive:"60-Sekunden-Sprint mit Serien.",btn_mcq:"Mehrfachauswahl",btn_typing:"Eingeben ‚å®Ô∏è",
        title_filters:"Filter",title_leaderboard:"Lokale Bestenliste",btn_back:"Zur√ºck",btn_skip:"√úberspringen",title_settings:"Einstellungen",label_language:"Sprache",
        title_parental:"Eltern / Lehrer",label_pin:"PIN zum Zur√ºcksetzen (Standard 1234)",btn_reset:"Zur√ºcksetzen",btn_close:"Schlie√üen",label_donate:"Spendenlink anzeigen",
        learning:"Lernen",competitive:"Wettkampf ‚è±Ô∏è",streak:"Serie",score:"Punkte",time:"Zeit",hint_continent:"Kontinent:",hint_first:"Erster Buchstabe:",
        btn_show_hint:"Hinweis zeigen üí°", btn_hide_hint:"Hinweis verbergen üí°",
        correct:"Richtig!",wrong:"Nochmal versuchen!",over:"Zeit abgelaufen!",donate_text:"Spenden",
        africa:"Afrika",asia:"Asien",europe:"Europa",north_america:"Nordamerika",south_america:"S√ºdamerika",oceania:"Ozeanien",
        th_date:"Datum",th_mode:"Modus",th_variant:"Variante",th_continents:"Kontinente",th_score:"Punkte",th_beststreak:"Beste Serie",
        ph_typing:"Land eingeben‚Ä¶",btn_ok:"OK"},
    it:{title_play:"Gioca",desc_learning:"Modalit√† rilassata con suggerimenti.",desc_competitive:"Sprint di 60 s con serie.",btn_mcq:"Scelta multipla",btn_typing:"Scrivi il nome ‚å®Ô∏è",
        title_filters:"Filtri",title_leaderboard:"Classifica locale",btn_back:"Indietro",btn_skip:"Salta",title_settings:"Impostazioni",label_language:"Lingua",
        title_parental:"Genitori / Docente",label_pin:"PIN per reimpostare (predef. 1234)",btn_reset:"Reimposta",btn_close:"Chiudi",label_donate:"Mostra link donazione",
        learning:"Apprendimento",competitive:"Competitivo ‚è±Ô∏è",streak:"Serie",score:"Punteggio",time:"Tempo",hint_continent:"Continente:",hint_first:"Prima lettera:",
        btn_show_hint:"Mostra suggerimento üí°", btn_hide_hint:"Nascondi suggerimento üí°",
        correct:"Corretto!",wrong:"Riprova!",over:"Tempo scaduto!",donate_text:"Dona",
        africa:"Africa",asia:"Asia",europe:"Europa",north_america:"America del Nord",south_america:"America del Sud",oceania:"Oceania",
        th_date:"Data",th_mode:"Modalit√†",th_variant:"Variante",th_continents:"Continenti",th_score:"Punteggio",th_beststreak:"Serie migliore",
        ph_typing:"Scrivi il paese‚Ä¶",btn_ok:"OK"},
    ru:{title_play:"–ò–≥—Ä–∞—Ç—å",desc_learning:"–°–ø–æ–∫–æ–π–Ω—ã–π —Ä–µ–∂–∏–º —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏.",desc_competitive:"–°–ø—Ä–∏–Ω—Ç 60 —Å —Å —Å–µ—Ä–∏—è–º–∏.",btn_mcq:"–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞",btn_typing:"–í–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ ‚å®Ô∏è",
        title_filters:"–§–∏–ª—å—Ç—Ä—ã",title_leaderboard:"–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥",btn_back:"–ù–∞–∑–∞–¥",btn_skip:"–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å",title_settings:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏",label_language:"–Ø–∑—ã–∫",
        title_parental:"–†–æ–¥–∏—Ç–µ–ª–∏ / –£—á–∏—Ç–µ–ª—å",label_pin:"PIN –¥–ª—è —Å–±—Ä–æ—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1234)",btn_reset:"–°–±—Ä–æ—Å–∏—Ç—å",btn_close:"–ó–∞–∫—Ä—ã—Ç—å",label_donate:"–ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –¥–æ–Ω–∞—Ç–∞",
        learning:"–û–±—É—á–µ–Ω–∏–µ",competitive:"–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ ‚è±Ô∏è",streak:"–°–µ—Ä–∏—è",score:"–û—á–∫–∏",time:"–í—Ä–µ–º—è",hint_continent:"–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç:",hint_first:"–ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞:",
        btn_show_hint:"–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É üí°", btn_hide_hint:"–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É üí°",
        correct:"–í–µ—Ä–Ω–æ!",wrong:"–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë!",over:"–í—Ä–µ–º—è –≤—ã—à–ª–æ!",donate_text:"–î–æ–Ω–∞—Ç",
        africa:"–ê—Ñ—Ä–∏–∫–∞",asia:"–ê–∑–∏—è",europe:"–ï–≤—Ä–æ–ø–∞",north_america:"–°–µ–≤–µ—Ä–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞",south_america:"–Æ–∂–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞",oceania:"–û–∫–µ–∞–Ω–∏—è",
        th_date:"–î–∞—Ç–∞",th_mode:"–†–µ–∂–∏–º",th_variant:"–í–∞—Ä–∏–∞–Ω—Ç",th_continents:"–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã",th_score:"–û—á–∫–∏",th_beststreak:"–õ—É—á—à–∞—è —Å–µ—Ä–∏—è",
        ph_typing:"–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É‚Ä¶",btn_ok:"OK"},
    pt:{title_play:"Jogar",desc_learning:"Modo relaxado com dicas.",desc_competitive:"Corrida de 60 s com sequ√™ncias.",btn_mcq:"M√∫ltipla escolha",btn_typing:"Digitar nome ‚å®Ô∏è",
        title_filters:"Filtros",title_leaderboard:"Placar local",btn_back:"Voltar",btn_skip:"Pular",title_settings:"Configura√ß√µes",label_language:"Idioma",
        title_parental:"Pais / Professor",label_pin:"PIN para redefinir (padr√£o 1234)",btn_reset:"Redefinir",btn_close:"Fechar",label_donate:"Mostrar link de doa√ß√£o",
        learning:"Aprender",competitive:"Competitivo ‚è±Ô∏è",streak:"Sequ√™ncia",score:"Pontua√ß√£o",time:"Tempo",hint_continent:"Continente:",hint_first:"Primeira letra:",
        btn_show_hint:"Mostrar dica üí°", btn_hide_hint:"Ocultar dica üí°",
        correct:"Correto!",wrong:"Tente novamente!",over:"O tempo acabou!",donate_text:"Doar",
        africa:"√Åfrica",asia:"√Åsia",europe:"Europa",north_america:"Am√©rica do Norte",south_america:"Am√©rica do Sul",oceania:"Oceania",
        th_date:"Data",th_mode:"Modo",th_variant:"Variante",th_continents:"Continentes",th_score:"Pontua√ß√£o",th_beststreak:"Melhor sequ√™ncia",
        ph_typing:"Digite o pa√≠s‚Ä¶",btn_ok:"OK"}
  };
  let LANG = (localStorage.getItem('lang')) || ((navigator.language||'en').slice(0,2));
  if(!Object.keys(I18N).includes(LANG)) LANG='en';
  function t(k){return (I18N[LANG]&&I18N[LANG][k])||I18N.en[k]||k}
  function langFlag(code){return ({en:'üá¨üáß',pl:'üáµüá±',es:'üá™üá∏',de:'üá©üá™',it:'üáÆüáπ',ru:'üá∑üá∫',pt:'üáµüáπ'})[code]||'üåê'}
  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent=t(el.getAttribute('data-i18n')); });
    document.getElementById('donateLink').textContent=t('donate_text');
    // Update language button label with flag + code
    const btn=document.getElementById('btnLanguage');
    btn.innerHTML = `<span class="lang-flag">${langFlag(LANG)}</span><span class="lang-code">${(LANG||'en').toUpperCase()}</span>`;
  }

  // --- Dataset ---
  const DATASET_URL="https://cdn.jsdelivr.net/npm/world-countries@latest/countries.json";
  const FALLBACK=[
    {cca2:"PL",region:"Europe",name:{common:"Poland"},translations:{pol:{common:"Polska"},spa:{common:"Polonia"}}},
    {cca2:"ES",region:"Europe",name:{common:"Spain"},translations:{pol:{common:"Hiszpania"},spa:{common:"Espa√±a"}}},
    {cca2:"FR",region:"Europe",name:{common:"France"},translations:{pol:{common:"Francja"},spa:{common:"Francia"}}},
    {cca2:"DE",region:"Europe",name:{common:"Germany"},translations:{pol:{common:"Niemcy"},spa:{common:"Alemania"}}},
    {cca2:"GB",region:"Europe",name:{common:"United Kingdom"},translations:{pol:{common:"Wielka Brytania"},spa:{common:"Reino Unido"}}},
    {cca2:"US",region:"North America",name:{common:"United States"},translations:{pol:{common:"Stany Zjednoczone"},spa:{common:"Estados Unidos"}}},
    {cca2:"BR",region:"South America",name:{common:"Brazil"},translations:{pol:{common:"Brazylia"},spa:{common:"Brasil"}}},
    {cca2:"CN",region:"Asia",name:{common:"China"},translations:{pol:{common:"Chiny"},spa:{common:"China"}}},
    {cca2:"JP",region:"Asia",name:{common:"Japan"},translations:{pol:{common:"Japonia"},spa:{common:"Jap√≥n"}}},
    {cca2:"AU",region:"Oceania",name:{common:"Australia"},translations:{pol:{common:"Australia"},spa:{common:"Australia"}}},
    {cca2:"ZA",region:"Africa",name:{common:"South Africa"},translations:{pol:{common:"Republika Po≈Çudniowej Afryki"},spa:{common:"Sud√°frica"}}}
  ];
  let COUNTRIES=[];
  function normalize(raw){
    return raw.map(c=>{
      const code=(c.cca2||c.ccn3||"").toUpperCase();
      const region=c.region||"Other";
      const name_en=c.name?.common||code;
      const name_pl=c.translations?.pol?.common||name_en;
      const name_es=c.translations?.spa?.common||name_en;
      return {code,region,name_en,name_pl,name_es};
    }).filter(c=>c.code && c.region && c.region!=="Antarctica");
  }
  async function loadCountries(){
    try{
      const res=await fetch(DATASET_URL,{cache:'no-cache'});
      if(!res.ok) throw new Error('fetch failed');
      const json=await res.json();
      COUNTRIES=normalize(json);
    }catch(e){
      console.warn('Using FALLBACK dataset:',e);
      COUNTRIES=normalize(FALLBACK);
    }
  }

  // --- Utils ---
  const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a}
  function choice(a){return a[Math.floor(Math.random()*a.length)]}
  function normalizeStr(s){return (s||'').toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-z0-9\\s]/g,'').replace(/\\s+/g,' ').trim()}

  // --- Audio ---
  const audioCtx = (window.AudioContext? new AudioContext(): null);
  function beep(freq=440,dur=120,type='sine',vol=0.2){
    if(!audioCtx || audioCtx.state==='closed') return;
    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>o.stop(), dur);
  }

  // --- State ---
  const state={mode:'learning',variant:'mcq',continents:new Set(["Africa","Asia","Europe","North America","South America","Oceania"]),
    timeLeft:60,score:0,streak:0,bestStreak:0,current:null,options:[],timerId:null,running:false,hintShown:false};

  function getName(c){return LANG==='pl'?c.name_pl: (LANG==='es'?c.name_es:c.name_en)}
  function getAllNameVariants(c){
    const names=new Set([c.name_en,c.name_pl,c.name_es]);
    const aliases={
      "Cote d Ivoire":["C√¥te d'Ivoire","Ivory Coast"], "United States":["USA","US","United States of America","Estados Unidos","Stany Zjednoczone"],
      "United Kingdom":["UK","Great Britain","Britain","Wielka Brytania","Reino Unido"], "Russia":["Russian Federation","Federacja Rosyjska","Rusia"],
      "South Korea":["Korea, South","Republic of Korea","Korea Po≈Çudniowa","Corea del Sur"], "North Korea":["Korea, North","DPRK","Korea P√≥≈Çnocna","Corea del Norte"],
      "Czechia":["Czech Republic","Czechy","Chequia"], "T√ºrkiye":["Turkey","Turcja","Turqu√≠a"], "Eswatini":["Swaziland","Suazi"],
      "Cape Verde":["Cabo Verde"], "Timor-Leste":["East Timor","Timor Wschodni","Timor Oriental"]
    };
    Object.values(aliases).forEach(list=> list.forEach(n=>names.add(n)));
    return Array.from(names);
  }
  function countriesByContinents(){return COUNTRIES.filter(c=>state.continents.has(c.region))}
  function loadScores(){try{return JSON.parse(localStorage.getItem('scores')||'[]')}catch{return []}}
  function saveScore(e){const s=loadScores(); s.push(e); s.sort((a,b)=>b.score-a.score); localStorage.setItem('scores',JSON.stringify(s.slice(0,20)))}
  function renderLeaderboard(){
    const box=$('#leaderboard'); const s=loadScores();
    if(s.length===0){ box.innerHTML = '<p class="muted">No scores yet.</p>'; return; }
    const variantLabel = (v)=> v==='mcq' ? t('btn_mcq') : t('btn_typing');
    const rows = s.map(r=> `<tr><td>${r.date}</td><td>${t(r.mode)||r.mode}</td><td>${variantLabel(r.variant)}</td><td>${r.conts.join(', ')}</td><td>${r.score}</td><td>${r.bestStreak}</td></tr>`).join('');
    box.innerHTML = `<div class="table-wrap">
      <table>
        <thead><tr>
          <th>${t('th_date')}</th>
          <th>${t('th_mode')}</th>
          <th>${t('th_variant')}</th>
          <th>${t('th_continents')}</th>
          <th>${t('th_score')}</th>
          <th>${t('th_beststreak')}</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  }

  function startGame(mode,variant){
    state.mode=mode; state.variant=variant; state.timeLeft=(mode==='competitive')?60:0; state.score=0; state.streak=0; state.bestStreak=0; state.running=true; state.hintShown=false;
    $('#screenStart').classList.remove('active'); $('#screenGame').classList.add('active');
    $('#hudMode').textContent = t(mode)+' ‚Ä¢ '+(variant==='mcq'?t('btn_mcq'):t('btn_typing'));
    $('#hudScore').textContent = t('score')+': 0'; $('#hudStreak').textContent=t('streak')+': 0';
    $('#hudTimer').textContent = (mode==='competitive') ? (t('time')+': '+state.timeLeft) : '';
    $('#hintBox').textContent='';
    const toggleBtn = document.getElementById('btnToggleHint');
    toggleBtn.classList.toggle('hidden', mode!=='learning');
    if(mode==='learning'){ toggleBtn.textContent = t('btn_show_hint'); }
    nextQuestion(); if(mode==='competitive') startTimer();
  }
  function startTimer(){ clearInterval(state.timerId); state.timerId=setInterval(()=>{
    state.timeLeft--; $('#hudTimer').textContent=t('time')+': '+state.timeLeft; if(state.timeLeft<=0){clearInterval(state.timerId); endGame();}
  }, 1000); }
  function endGame(){
    state.running=false;
    $('#hintBox').textContent=t('over'); beep(330,250,'sawtooth',0.15);
    const conts=Array.from(state.continents); saveScore({ date:new Date().toLocaleDateString(),mode:state.mode,variant:state.variant,conts,score:state.score,bestStreak:state.bestStreak });
    renderLeaderboard();
    setTimeout(()=>{ $('#screenGame').classList.remove('active'); $('#screenStart').classList.add('active'); }, 1500);
  }
  function pickCountry(){ const pool=countriesByContinents(); return choice(pool); }
  function flagUrl(code){ return 'https://flagcdn.com/w640/'+code.toLowerCase()+'.png'; }
  function placeholderFlag(){
    const svg='<svg xmlns="http://www.w3.org/2000/svg" width="640" height="400"><rect width="640" height="400" fill="#0ea5e9"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="42" fill="#0b1220">Flag unavailable offline</text></svg>';
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  }
  function nextQuestion(){
    state.current=pickCountry();
    const img=$('#flagImg');
    img.onerror=()=>{ img.onerror=null; img.src=placeholderFlag(); };
    img.src=flagUrl(state.current.code);
    state.hintShown=false;
    $('#hintBox').textContent='';
    const toggleBtn = document.getElementById('btnToggleHint');
    if(state.mode==='learning'){ toggleBtn.textContent = t('btn_show_hint'); }
    renderQuestion();
  }
  function renderQuestion(){
    const area=$('#questionArea'); area.innerHTML='';
    if(state.variant==='mcq'){
      const options=generateOptions(state.current); state.options=options;
      const grid=document.createElement('div'); grid.className='options';
      options.forEach(opt=>{ const btn=document.createElement('button'); btn.className='option'; btn.textContent=getName(opt); btn.addEventListener('click',()=>onAnswer(opt)); grid.appendChild(btn); });
      area.appendChild(grid);
    }else{
      const wrap=document.createElement('div'); wrap.className='input-wrap';
      const input=document.createElement('input'); input.placeholder=t('ph_typing'); input.autocomplete='off'; input.setAttribute('aria-label', t('ph_typing'));
      const confirm=document.createElement('button'); confirm.className='btn'; confirm.textContent=t('btn_ok'); confirm.addEventListener('click',()=>onTyping(input.value));
      input.addEventListener('keydown',e=>{if(e.key==='Enter') onTyping(input.value)});
      wrap.appendChild(input); wrap.appendChild(confirm); area.appendChild(wrap);
      const sugg=document.createElement('div'); sugg.className='autocomplete'; area.appendChild(sugg);
      input.addEventListener('input',()=>{
        const q=normalizeStr(input.value); if(!q){sugg.innerHTML=''; return;}
        const picks=countriesByContinents().filter(c=> normalizeStr(getName(c)).startsWith(q) ).slice(0,6);
        sugg.innerHTML=picks.map(p=>`<div class="suggestion">${getName(p)}</div>`).join('');
        sugg.querySelectorAll('.suggestion').forEach(s=> s.addEventListener('click',()=>{input.value=s.textContent; sugg.innerHTML=''}));
      });
    }
  }
  function generateOptions(answer){
    const pool=countriesByContinents(); let others=pool.filter(c=>c.code!==answer.code);
    const same=others.filter(c=>c.region===answer.region); const wrongs=shuffle((same.length>=3?same:others)).slice(0,3);
    return shuffle([answer, ...wrongs]);
  }
  function onAnswer(picked){
    const correct=picked.code===state.current.code; const buttons=[...document.querySelectorAll('.option')];
    buttons.forEach(btn=>{ const isAns=btn.textContent===getName(state.current); btn.classList.toggle('correct', isAns); if(btn.textContent===getName(picked)) btn.classList.add(correct?'correct':'wrong'); });
    if(correct) onCorrect(); else onWrong();
  }
  function onTyping(value){
    const target=state.current; const v=normalizeStr(value); const variants=getAllNameVariants(target).map(normalizeStr);
    if(variants.includes(v)) onCorrect(); else onWrong();
  }
  function onCorrect(){
    beep(660,120,'triangle',0.15);
    let add=100; state.streak=Math.min(state.streak+1,10); state.bestStreak=Math.max(state.bestStreak,state.streak);
    const mult = state.streak<3?1:(state.streak<5?1.2:(state.streak<8?1.5:2)); state.score+=Math.floor(add*mult);
    document.getElementById('hudScore').textContent=t('score')+': '+state.score; document.getElementById('hudStreak').textContent=t('streak')+': '+state.streak;
    setTimeout(()=>nextQuestion(),400);
  }
  function onWrong(){
    beep(220,150,'square',0.15);
    if(state.mode==='competitive'){ state.timeLeft=Math.max(0,state.timeLeft-2); document.getElementById('hudTimer').textContent=t('time')+': '+state.timeLeft; }
    state.streak=0; document.getElementById('hudStreak').textContent=t('streak')+': 0';
  }

  // Hint toggle (no layout shift)
  function toggleHint(){
    if(state.mode!=='learning' || !state.current) return;
    state.hintShown = !state.hintShown;
    const btn=document.getElementById('btnToggleHint');
    if(state.hintShown){
      document.getElementById('hintBox').textContent = t('hint_continent')+' '+state.current.region+' ‚Ä¢ '+t('hint_first')+' '+getName(state.current)[0];
      btn.textContent = t('btn_hide_hint');
    }else{
      document.getElementById('hintBox').textContent = '';
      btn.textContent = t('btn_show_hint');
    }
  }

  // --- UI ---
  function initUI(){
    document.getElementById('year').textContent=new Date().getFullYear();
    applyI18n();
    // Language dropdown
    const btnLang=document.getElementById('btnLanguage');
    const menu=document.getElementById('langMenu');
    btnLang.addEventListener('click',()=>{ menu.classList.toggle('open'); });
    menu.addEventListener('click', (e)=>{
      const item=e.target.closest('.lang-item'); if(!item) return;
      LANG=item.getAttribute('data-lang'); localStorage.setItem('lang',LANG);
      menu.classList.remove('open');
      applyI18n(); renderLeaderboard(); renderQuestion();
    });
    document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==btnLang){ menu.classList.remove('open'); } });

    const sel=document.getElementById('selLang'); sel.value=LANG; sel.addEventListener('change',e=>{
      LANG=e.target.value; localStorage.setItem('lang',LANG); applyI18n(); renderLeaderboard(); renderQuestion();
    });

    document.getElementById('btnSettings').addEventListener('click',()=>document.getElementById('dlgSettings').showModal());
    document.getElementById('btnResetProgress').addEventListener('click',()=>{
      const pin=document.getElementById('pinInput').value.trim();
      if(pin===(localStorage.getItem('pin')||'1234')){ localStorage.removeItem('scores'); renderLeaderboard(); alert('Progress reset.'); } else { alert('Wrong PIN.'); }
    });
    document.getElementById('chkDonate').checked = localStorage.getItem('donate')==='1';
    document.getElementById('chkDonate').addEventListener('change',e=>{
      localStorage.setItem('donate', e.target.checked?'1':'0'); document.getElementById('donateLink').classList.toggle('hidden', !e.target.checked);
    });
    document.getElementById('donateLink').classList.toggle('hidden', localStorage.getItem('donate')!=='1');
    document.getElementById('donateLink').href='https://buymeacoffee.com/';

    document.querySelectorAll('#screenStart .btn').forEach(btn=>{
      const m=btn.getAttribute('data-mode'); const v=btn.getAttribute('data-variant'); if(m&&v){ btn.addEventListener('click',()=>startGame(m,v)); }
    });
    document.getElementById('btnBack').addEventListener('click',()=>{
      clearInterval(state.timerId); document.getElementById('screenGame').classList.remove('active'); document.getElementById('screenStart').classList.add('active'); state.running=false;
    });
    document.getElementById('btnSkip').addEventListener('click', ()=> nextQuestion());
    document.getElementById('btnToggleHint').addEventListener('click', toggleHint);
    document.querySelectorAll('.continent').forEach(cb=> cb.addEventListener('change',()=>{
      if(cb.checked) state.continents.add(cb.value); else state.continents.delete(cb.value);
    }));
  }

  async function boot(){ initUI(); renderLeaderboard(); await loadCountries(); }
  boot();
  </script>
</body>
</html>
