<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Spelling Quest ‚Äî PL</title>
<meta name="description" content="Polska gra: stukaj litery, by u≈Ço≈ºyƒá s≈Çowo z emoji. Tryb Nauka i Rywalizacja.">
<style>
:root{
  --bg:#0b1220; --card:#0f172a; --text:#f3f4f6; --muted:#cbd5e1; --accent:#0ea5e9;
  --shadow:0 10px 30px rgba(0,0,0,.3);
  --good:#16a34a; --bad:#ef4444; --warn:#f59e0b;
  --tile:#182237; --tile-b:#2b3a59; --tile-h:#223157;
  --yellow:#facc15; --used:#e5e7eb; --used-text:#111827;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
     background:radial-gradient(1000px 600px at 20% -10%, #23325a, #0b1220); color:var(--text);
     display:flex; flex-direction:column}
header, footer{display:flex;align-items:center;justify-content:space-between;gap:12px;
     padding:12px 16px;background:rgba(15,23,42,.75);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.08)}
footer{border-top:1px solid rgba(255,255,255,.08);margin-top:auto}
.brand{display:flex;align-items:center;gap:10px}
.btn{border:none;background:var(--accent);color:black;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
.btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.3)}
main{max-width:980px;width:100%;margin:0 auto;padding:12px}
.card{background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.space{justify-content:space-between}
.hud{display:flex;gap:12px;align-items:center;font-weight:800}
#hudTimer{color:var(--warn)} #hudScore{color:#34d399} #hudStreak{color:#93c5fd}
.muted{color:var(--muted)}

.screen{display:none} .screen.active{display:block}

/* Stage */
.stage{display:flex;justify-content:center;align-items:center;min-height:200px}
.pic{font-size:6rem; filter: drop-shadow(0 6px 16px rgba(0,0,0,.45))}
@media (min-width:600px){ .pic{font-size:8rem} }

/* Tiles (placeholders + letters) */
.grid{--cols:5; --gap:12px; display:grid; grid-template-columns:repeat(var(--cols), 1fr); gap:var(--gap); margin:12px 0}
.tile{
  display:flex; align-items:center; justify-content:center; user-select:none;
  border-radius:14px; border:2px solid var(--tile-b); background:var(--tile);
  min-height:64px; aspect-ratio:1/1; font-weight:900; font-size:1.6rem; letter-spacing:.02em;
  box-shadow:var(--shadow);
}
.tile.placeholder{background:#0a0f1d}
.tile.bank{background:var(--yellow); color:#111; border-color:#d4b30f}
.tile.bank.used{background:var(--used); color:var(--used-text); border-color:#cbd5e1}
.tile.success{outline:3px solid var(--good); box-shadow:0 0 0 4px rgba(22,163,74,.25) inset}
.tile.fail{outline:3px solid var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.25) inset}

#placeholders.shake{animation:shake .25s}
@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}
50%{transform:translateX(6px)}75%{transform:translateX(-6px)}100%{transform:translateX(0)}}

/* Leaderboard table */
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.15);text-align:left}
th{color:#c7d2fe;font-weight:800}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <div style="width:36px;height:36px;border-radius:8px;background:#0ea5e9;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)">üî§</div>
      <h1 style="margin:0">Spelling Quest</h1>
    </div>
    <div class="row">
      <button id="btnSpeak" class="btn secondary" title="Wypowiedz s≈Çowo">üîä</button>
      <button id="btnBack" class="btn secondary">‚Üê Powr√≥t</button>
    </div>
  </header>

  <main>
    <!-- Start Screen -->
    <section id="screenStart" class="screen active">
      <div class="card">
        <h2>Graj</h2>
        <div class="row">
          <div class="card" style="flex:1;min-width:260px">
            <h3>Nauka</h3>
            <p class="muted">Spokojnie, bez limitu czasu.</p>
            <button class="btn" data-mode="learning">Start</button>
          </div>
          <div class="card" style="flex:1;min-width:260px">
            <h3>Rywalizacja</h3>
            <p class="muted">60 sekund, serie i rekordy.</p>
            <button class="btn" data-mode="competitive">Start</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Lokalne rekordy</h2>
        <div id="leaderboard"></div>
      </div>
    </section>

    <!-- Game Screen -->
    <section id="screenGame" class="screen">
      <div class="row space">
        <div class="hud">
          <span id="hudMode"></span>
          <span id="hudTimer"></span>
          <span id="hudScore"></span>
          <span id="hudStreak"></span>
        </div>
        <div class="row">
          <button id="btnSkip" class="btn secondary">Pomi≈Ñ</button>
        </div>
      </div>

      <div class="stage"><div id="pic" class="pic" aria-hidden="true">üçé</div></div>

      <!-- Placeholders -->
      <div id="placeholders" class="grid" style="--cols:5"></div>

      <!-- Letter bank -->
      <div id="bank" class="grid" style="--cols:5"></div>
      <div id="wordCount" class="muted" style="text-align:right;font-size:.8rem;margin-top:8px"></div>

    </section>
  </main>

  <footer>
    <span class="muted">&copy; <span id="year"></span> Spelling Quest</span>
  </footer>

<script>
// ===== Dataset (100+ s≈Ç√≥w, emoji) =====
const WORDS = [
  // Zwierzƒôta
  ["üê∂","PIES"],["üê±","KOT"],["üß∏","MI≈ö"],["ü¶ä","LIS"],["üê∫","WILK"],["üê∞","KR√ìLIK"],["üêÆ","KROWA"],["üêê","KOZA"],
  ["üêë","OWCA"],["üê∑","≈öWINIA"],["üêî","KURA"],["üêì","KOGUT"],["ü¶Ü","KACZKA"],["ü¶¢","Gƒò≈ö"],["ü¶É","INDYK"],["üê¶","PTAK"],
  ["üïäÔ∏è","GO≈ÅƒÑB"],["ü¶â","SOWA"],["üêß","PINGWIN"],["üê•","PISKLAK"],["ü¶Å","LEW"],["üêØ","TYGRYS"],["üêò","S≈ÅO≈É"],["ü¶í","≈ªYRAFA"],
  ["ü¶ì","ZEBRA"],["üê®","KOALA"],["üêí","MA≈ÅPA"],["üêä","KROKODYL"],["üêç","WƒÑ≈ª"],["üê¢","≈ª√ì≈ÅW"],["üê∏","≈ªABA"],["üêü","RYBA"],
  ["üê¨","DELFIN"],["ü¶à","REKIN"],["üêã","WIELORYB"],["üêô","O≈öMIORNICA"],["ü¶ê","KREWETKA"],["üêå","≈öLIMAK"],["üêù","PSZCZO≈ÅA"],["üêû","BIEDRONKA"],
  ["üï∑Ô∏è","PAJƒÑK"],["ü¶ã","MOTYL"],

  // Owoce/warzywa/jedzenie
  ["üçé","JAB≈ÅKO"],["üçê","GRUSZKA"],["üçá","WINOGRONO"],["üçì","TRUSKAWKA"],["üçì","MALINA"],["ü´ê","BOR√ìWKA"],["üçã","CYTRYNA"],["üçä","POMARA≈ÉCZA"],
  ["üçå","BANAN"],["üçâ","ARBUZ"],["üçç","ANANAS"],["üçí","WI≈öNIA"],["üçÖ","POMIDOR"],["ü•ï","MARCHEWKA"],["ü•í","OG√ìREK"],["üå∂Ô∏è","PAPRYKA"],
  ["üåΩ","KUKURYDZA"],["üçÜ","BAK≈ÅA≈ªAN"],["ü•¶","BROKU≈Å"],["üçÑ","GRZYB"],["üçû","CHLEB"],["üç∞","CIASTO"],["üç¶","LODY"],["üßÄ","SER"],
  ["ü•õ","MLEKO"],["üçï","PIZZA"],["üçî","BURGER"],["ü•ö","JAJKO"],["ü•£","ZUPA"],["üçö","RY≈ª"],["üçù","MAKARON"],["‚òï","KAWA"],["üçµ","HERBATA"],

  // Pojazdy
  ["üö≤","ROWER"],["üöó","SAMOCH√ìD"],["üöå","AUTOBUS"],["üöÜ","POCIƒÑG"],["üöã","TRAMWAJ"],["üöá","METRO"],["üèçÔ∏è","MOTOR"],["üöú","TRAKTOR"],
  ["üöÅ","HELIKOPTER"],["‚úàÔ∏è","SAMOLOT"],["üö¢","STATEK"],["üö§","≈Å√ìDKA"],["üõ¥","HULAJNOGA"],["üöõ","TIR"],["üöö","CIƒò≈ªAR√ìWKA"],

  // Przedmioty/dom
  ["üè†","DOM"],["üîë","KLUCZ"],["üõèÔ∏è","≈Å√ì≈ªKO"],["ü™ë","KRZES≈ÅO"],["üçΩÔ∏è","ST√ì≈Å"],["üí°","LAMPA"],["‚è∞","ZEGAR"],["üìö","KSIƒÑ≈ªKA"],
  ["‚úèÔ∏è","O≈Å√ìWEK"],["üñäÔ∏è","D≈ÅUGOPIS"],["üéí","PLECAK"],["üëì","OKULARY"],["üì±","TELEFON"],["üíª","KOMPUTER"],["üì∫","TELEWIZOR"],
  ["üìª","RADIO"],["üì∑","APARAT"],["‚òÇÔ∏è","PARASOL"],["‚úÇÔ∏è","NO≈ªYCZKI"],["üî®","M≈ÅOTEK"],["üé®","FARBY"],["üñãÔ∏è","PI√ìRO"],["üóíÔ∏è","ZESZYT"],

  // Natura/pogoda
  ["‚òÄÔ∏è","S≈ÅO≈ÉCE"],["‚òÅÔ∏è","CHMURA"],["üåßÔ∏è","DESZCZ"],["‚ùÑÔ∏è","≈öNIEG"],["üåà","TƒòCZA"],["üåô","KSIƒò≈ªYC"],["‚≠ê","GWIAZDA"],
  ["üå≥","DRZEWO"],["üå∑","KWIAT"],["üî•","OGIE≈É"],["üíß","WODA"],["ü™®","KAMIE≈É"],["‚õ∞Ô∏è","G√ìRA"]
];
// ensure all unique ids (use word)
const DATA = WORDS.map(([emo, w])=>({emoji:emo, word:w}));

// ===== Utils =====
const $=s=>document.querySelector(s);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a}
function choice(a){return a[Math.floor(Math.random()*a.length)]}

// ===== Audio (beeps + TTS PL) =====
let ctx=null;
function beep(freq=440,dur=120,type='sine',vol=0.2){
  try{
    ctx = ctx || new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>o.stop(), dur);
  }catch{}
}
let voices=[], voicePL=null, voiceEN=null;
function loadVoices(){
  if(!('speechSynthesis' in window)) return;
  voices = speechSynthesis.getVoices();
  voicePL = voices.find(v=>/pl/i.test(v.lang)) || null;
  voiceEN = voices.find(v=>/en/i.test(v.lang)) || null;
}
if('speechSynthesis' in window){ loadVoices(); speechSynthesis.onvoiceschanged=loadVoices; }
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = (voicePL && voicePL.lang) || 'pl-PL';
  u.voice = voicePL || voiceEN || null;
  u.rate=0.95; u.pitch=1; u.volume=1;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

// ===== State =====
const state = {
  mode:'learning',
  timeLeft:60, timerId:null,
  score:0, streak:0, bestStreak:0,
  current:null, typed:'', recent:[], RECENT_MAX:14
};

// ===== Leaderboard =====
function loadScores(){try{return JSON.parse(localStorage.getItem('spell_scores')||'[]')}catch{return []}}
function saveScore(e){
  const s=loadScores(); s.push(e); s.sort((a,b)=>b.score-a.score);
  localStorage.setItem('spell_scores', JSON.stringify(s.slice(0,20)));
}
function renderLeaderboard(){
  const s=loadScores();
  const box=$("#leaderboard");
  if(!s.length){ box.innerHTML='<p class="muted">Brak wynik√≥w.</p>'; return; }
  const rows = s.map(r=>`<tr><td>${r.date}</td><td>${r.mode==='competitive'?'Rywalizacja':'Nauka'}</td><td>${r.score}</td><td>${r.bestStreak}</td></tr>`).join('');
  box.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Data</th><th>Tryb</th><th>Wynik</th><th>Najlepsza seria</th></tr></thead>
    <tbody>${rows}</tbody></table></div>`;
}

// ===== Game picking (no frequent repeats) =====
function pickWord(){
  let w=null, tries=0;
  do{
    w = choice(DATA);
    tries++;
  }while(
    tries<40 &&
    (
      (state.current && w.word===state.current.word) ||
      state.recent.includes(w.word)
    )
  );
  return w || choice(DATA);
}

// ===== UI update =====
function updateHud(){
  $('#hudScore').textContent = 'Wynik: '+state.score;
  $('#hudStreak').textContent = 'Seria: '+state.streak;
  $('#hudTimer').textContent = state.mode==='competitive' ? ('Czas: '+state.timeLeft) : '';
  $('#hudMode').textContent = state.mode==='competitive' ? 'Rywalizacja' : 'Nauka';
}
function setCols(len){
  document.getElementById('placeholders').style.setProperty('--cols', Math.max(2, len));
  document.getElementById('bank').style.setProperty('--cols', Math.max(2, len));
}

// Build placeholders (first letter fixed)
function renderPlaceholders(){
  const wrap = $('#placeholders'); wrap.innerHTML='';
  const w = state.current.word;
  setCols(w.length);
  [...w].forEach((ch,i)=>{
    const t = document.createElement('div');
    t.className = 'tile placeholder';
    t.textContent = i===0 ? ch : (state.typed[i-1]||'');
    wrap.appendChild(t);
  });
}
function updateWordCounter(){
  const el = document.getElementById('wordCount');
  if (el) el.textContent = 'S≈Ç√≥w w zestawie: ' + DATA.length;
}

// Build letter bank (exact counts of remaining letters)
function renderBank(){
  const wrap = $('#bank'); wrap.innerHTML='';
  const w = state.current.word;

  // Build full multiset of letters (including the first one)
  const letters = [...w];                // ALL letters
  shuffle(letters);

  letters.forEach((ch, idx)=>{
    const b = document.createElement('button');
    b.className = 'tile bank';
    b.textContent = ch;

    // If this tile is the FIRST LETTER of the word, mark as already used+disabled
    // (pre-filled in the puzzle). We still display it so tile count matches.
    if (ch === w[0]) {
      b.classList.add('used');
      b.disabled = true;
    } else {
      b.addEventListener('click', ()=>{
        if(b.classList.contains('used')) return;
        b.classList.add('used'); b.disabled = true;
        state.typed += ch;
        renderPlaceholders();

        // finished attempt?
        if(state.typed.length === w.length-1){
          const full = w[0] + state.typed;
          if(full === w){ onCorrect(); } else { onWrong(); }
        }
      });
    }

    wrap.appendChild(b);
  });

  // Add invisible fillers if needed (keeps tile sizing perfect)
  while(wrap.children.length < w.length){
    const f = document.createElement('div');
    f.className='tile bank'; f.style.visibility='hidden';
    wrap.appendChild(f);
  }
}


function nextWord(){
  state.current = pickWord();
  state.recent.push(state.current.word);
  if(state.recent.length>state.RECENT_MAX) state.recent.shift();
  state.typed='';
  $('#pic').textContent = state.current.emoji;
  renderPlaceholders();
  renderBank();
  updateWordCounter();   // keep the label fresh (in case you swap datasets later)
  $('#placeholders').classList.remove('shake');
}

function onCorrect(){
  beep(660,120,'triangle',0.2);
  // highlight success
  [...document.querySelectorAll('#placeholders .tile')].forEach(t=>t.classList.add('success'));
  state.streak = Math.min(state.streak+1, 10);
  state.bestStreak = Math.max(state.bestStreak, state.streak);
  const mult = state.streak<3?1:(state.streak<5?1.2:(state.streak<8?1.5:2));
  state.score += Math.floor(100*mult);
  updateHud();
  speak(state.current.word.replaceAll('√ì','√≥').replaceAll('≈Å','≈Ç').replaceAll('≈ö','≈õ').replaceAll('ƒÜ','ƒá').replaceAll('≈É','≈Ñ').replaceAll('≈ª','≈º').replaceAll('≈π','≈∫').replaceAll('ƒò','ƒô').replaceAll('ƒÑ','ƒÖ'));
  setTimeout(()=>{
    [...document.querySelectorAll('#placeholders .tile')].forEach(t=>t.classList.remove('success'));
    nextWord();
  }, 700);
}

function onWrong(){
  beep(220,150,'square',0.2);
  if(state.mode==='competitive'){
    state.timeLeft = Math.max(0, state.timeLeft-2);
  }
  state.streak = 0;
  updateHud();
  // red feedback + reset attempt and bank
  const ph = $('#placeholders');
  ph.classList.add('shake');
  [...ph.children].forEach((t,i)=>{ if(i>0) t.classList.add('fail'); });
  setTimeout(()=>{
    ph.classList.remove('shake');
    [...ph.children].forEach((t,i)=>{ t.classList.remove('fail'); });
    state.typed='';
    renderPlaceholders();
    renderBank(); // re-enable letters
  }, 550);
}

// ===== Timer & Flow =====
function startTimer(){
  clearInterval(state.timerId);
  state.timeLeft = 60;
  updateHud();
  state.timerId = setInterval(()=>{
    state.timeLeft--;
    updateHud();
    if(state.timeLeft<=0){
      clearInterval(state.timerId);
      endGame();
    }
  }, 1000);
}

function startGame(mode){
  state.mode = mode;
  state.score = 0; state.streak = 0; state.bestStreak = 0;
  $('#screenStart').classList.remove('active'); $('#screenGame').classList.add('active');
  updateHud();
  nextWord();
  if(mode==='competitive') startTimer(); else clearInterval(state.timerId);
}
function endGame(){
  // save score (only for competitive)
  if(state.mode==='competitive'){
    saveScore({date:new Date().toLocaleDateString('pl-PL'), mode:state.mode, score:state.score, bestStreak:state.bestStreak});
    renderLeaderboard();
    updateWordCounter();
    
  }
  // brief message: reuse placeholders green then back to start
  [...document.querySelectorAll('#placeholders .tile')].forEach(t=>t.classList.add('success'));
  setTimeout(()=>{
    $('#screenGame').classList.remove('active'); $('#screenStart').classList.add('active');
  }, 1000);
}

// ===== UI wiring =====
document.getElementById('year').textContent=new Date().getFullYear();
document.querySelectorAll('#screenStart .btn').forEach(b=>{
  const mode=b.getAttribute('data-mode'); if(mode){ b.addEventListener('click', ()=>startGame(mode)); }
});
document.getElementById('btnSkip').addEventListener('click', ()=>{
  if(state.mode==='competitive'){ state.timeLeft = Math.max(0, state.timeLeft-2); updateHud(); }
  nextWord();
});
document.getElementById('btnSpeak').addEventListener('click', ()=>{ if(state.current) speak(state.current.word); });

// Back: index.html if present, otherwise history.back
document.getElementById('btnBack').addEventListener('click', ()=>{
  const inGame = document.getElementById('screenGame').classList.contains('active');
  if (inGame) {
    // Go back to this game's start screen (mode selection), not the dashboard
    clearInterval(state.timerId);
    document.getElementById('screenGame').classList.remove('active');
    document.getElementById('screenStart').classList.add('active');
    return;
  }

  // If already at the start screen, try dashboard (Android TWA may ignore this)
  fetch('index.html', {method:'HEAD'}).then(r=>{
    if(r.ok) location.href='index.html'; else history.back();
  }).catch(()=>history.back());
});


// Boot
renderLeaderboard();
</script>
</body>
</html>
